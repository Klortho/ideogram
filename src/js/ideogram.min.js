var Ideogram=function(c){this.config=JSON.parse(JSON.stringify(c));this.debug=!1;this.config.container||(this.config.container="body");this.config.resolution||(this.config.resolution=850);this.config.brush||(this.config.brush=!1);this.config.rows||(this.config.rows=1);!1==="chrHeight"in c&&(c.chrHeight=500);this.bump=Math.round(c.chrHeight/125);this.adjustedBump=!1;200>c.chrHeight&&(this.adjustedBump=!0,this.bump=4);c.showBandLabels&&(this.config.chrMargin+=20);this.config.annotationsPath||this.config.localAnnotationsPath?
(this.config.annotationHeight||(this.config.annotationHeight=3),this.config.numAnnotTracks=this.config.annotationTracks?this.config.annotationTracks.length:1,this.config.annotTracksHeight=this.config.annotationHeight*this.config.numAnnotTracks,"undefined"===typeof this.config.barWidth&&(this.config.barWidth=10)):this.config.annotTracksHeight=0;this.config.chrMargin=this.config.chrMargin+this.config.chrWidth+2*this.config.annotTracksHeight;c.onLoad&&(this.onLoadCallback=c.onLoad);c.onDrawAnnots&&(this.onDrawAnnotsCallback=
c.onDrawAnnots);c.onBrushMove&&(this.onBrushMoveCallback=c.onBrushMove);this.coordinateSystem="iscn";this.maxLength={bp:0,iscn:0};this.organisms={9606:{commonName:"Human",scientificName:"Homo sapiens",scientificNameAbbr:"H. sapiens"},10090:{commonName:"Mouse",scientificName:"Mus musculus",scientificNameAbbr:"M. musculus"}};this.config.annotationsPath&&!this.config.annotationHeight&&(this.config.annotationHeight=3);this.chromosomesArray=[];this.bandsToShow=[];this.chromosomes={};this.bandData={};this.init()};
Ideogram.prototype.getBands=function(c,d,a){var b=[],f,e,h,g;"undefined"===typeof chrBands?(delimiter=/\t/,c=c.split(/\r\n|\n/),h=1):(delimiter=/ /,h=0);for(g=c.length;h<g;h++)f=c[h].split(delimiter),f[0]===d&&(e=f[7],f[8]&&(e+=f[8]),f={chr:f[0],bp:{start:parseInt(f[5],10),stop:parseInt(f[6],10)},iscn:{start:parseInt(f[3],10),stop:parseInt(f[4],10)},px:{start:-1,stop:-1,width:-1},name:f[1]+f[2],stain:e,taxid:a},b.push(f));return b};
Ideogram.prototype.getChromosomeModel=function(c,d,a,b){var f={},e=this.config.chrHeight,h=this.maxLength,g;g=this.coordinateSystem;f.chrIndex=b;f.name=d;!0===this.config.fullChromosomeLabels&&(f.name=this.organisms[a].scientificNameAbbr+" chr"+f.name);f.id="chr"+d+"-"+a;f.length=c[c.length-1][g].stop;b=f.length;for(var k=pxStop=0;k<c.length;k++)d=c[k],a=e*f.length/h[g]*(d[g].stop-d[g].start)/b,c[k].px={start:pxStop,stop:pxStop+a,width:a},pxStop=c[k].px.stop,"acen"===d.stain&&"p"===d.name[0]&&(f.pcenIndex=
k);f.width=pxStop;f.scale={};!0===this.config.multiorganism?(f.scale.bp=1,f.scale.iscn=e*b/h.bp):(f.scale.bp=e/h.bp,f.scale.iscn=e/h.iscn);f.bands=c;f.centromerePosition="";1==c[0].bp.stop-c[0].bp.start&&(f.centromerePosition="telocentric",f.bands=f.bands.slice(1));return f};
Ideogram.prototype.drawChromosomeLabels=function(c){var d,a,b,f,e;a=[];for(b in c)for(d in c[b])a.push(c[b][d]);f=this;e=f.config.chrMargin-f.config.chrWidth-2;"vertical"===f.config.orientation&&!0===f.config.showBandLabels&&(e=f.config.chrMargin+8);"vertical"===f.config.orientation?d3.selectAll(".chromosome").append("text").data(a).attr("class","chrLabel").attr("transform","rotate(-90)").attr("y",-16).each(function(a,b){var c,d;c=a.name.split(" ");var l=[];if(void 0!=c)for(l.push(c.slice(0,c.length-
1).join(" ")),l.push(c[c.length-1]),f.config.showBandLabels||(b+=1),c=f.config.chrMargin*b,c=-(c+e)+3+2*f.config.annotTracksHeight,b=0;b<l.length;b++)d="",0==b&&f.config.fullChromosomeLabels&&(d="italic"),d3.select(this).append("tspan").text(l[b]).attr("dy",b?"1.2em":0).attr("x",c).attr("text-anchor","middle").attr("class",d)}):d3.selectAll(".chromosome").append("text").data(a).attr("class","chrLabel").attr("x",-5).each(function(b,a){var c,d;c=b.name.split(" ");var l=[];if(void 0!=c)for(l.push(c.slice(0,
c.length-1).join(" ")),l.push(c[c.length-1]),c=f.config.chrMargin*a,c=c+e+9,a=0;a<l.length;a++)d="",0==a&&f.config.fullChromosomeLabels&&(d="italic"),d3.select(this).append("tspan").text(l[a]).attr("dy",a?"1.2em":0).attr("y",c).attr("x",-8).attr("text-anchor","middle").attr("class",d)})};
Ideogram.prototype.drawBandLabels=function(c){var d,a,b,f;f=this;a=[];for(b in c)for(d in c[b])a.push(c[b][d]);var e={};for(c=chrIndex=0;c<a.length;c++){chrIndex+=1;chrModel=a[c];d=d3.select("#"+chrModel.id);var h=this.config.chrMargin*chrIndex,g;f=this;g=h;1==chrIndex&&"perspective"in this.config&&"comparative"==this.config.perspective&&(g+=18);e[chrModel.id]=[];d.selectAll("text").data(chrModel.bands).enter().append("g").attr("class",function(b,a){return"bandLabel bsbsl-"+a}).attr("transform",function(a){a=
f.round(-8+a.px.start+a.px.width/2);e[chrModel.id].push(a+13);return"translate("+a+","+(h-10)+")"}).append("text").text(function(a){return a.name});d.selectAll("line.bandLabelStalk").data(chrModel.bands).enter().append("g").attr("class",function(a,b){return"bandLabelStalk bsbsl-"+b}).attr("transform",function(a){return"translate("+f.round(a.px.start+a.px.width/2)+", "+g+")"}).append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",-8)}for(c=0;c<a.length;c++){chrModel=a[c];var k=e[chrModel.id].length,
m;b=[];var l,n,q;for(d=m=0;d<k;d++)n=e[chrModel.id][d],!1===n<m+5?(b.push(d),l!==d&&(prevTextBoxLeft=e[chrModel.id][d],prevTextBoxWidth=36,q=prevTextBoxLeft+prevTextBoxWidth),n<q+5?(l=d,m=q):b.push(d)):(l=d,m=q);k=[];m=b.length;for(n=0;n<m;n++)d=b[n],k.push("#"+chrModel.id+" .bsbsl-"+d);this.bandsToShow=this.bandsToShow.concat(k)}};
Ideogram.prototype.rotateChromosomeLabels=function(c,d,a,b){var f,e,h,g,k,m,l,n;e=this.config.chrWidth;f=this.config.chrMargin*d;m=this.config.numAnnotTracks;h=this;"undefined"===typeof b||!b.hasOwnProperty("x")||1==b.x&&1==b.y?(g=-8,k=-16,b={x:1,y:1},l=""):(l="scale("+b.x+","+b.y+")",g=-6,k=""===b?-16:-14);"vertical"==a||""==a?c.selectAll("text.chrLabel").attr("transform",l).selectAll("tspan").attr("x",g).attr("y",function(b,c){var f=d-1;(1<m||""==a)&&--f;chrMargin2=-4;!0===h.config.showBandLabels&&
(chrMargin2=h.config.chrMargin+e+26);f*=h.config.chrMargin;0==1<m&&(f+=1);return f+chrMargin2}):(--d,chrMargin2=-e-2,!0===h.config.showBandLabels&&(chrMargin2=h.config.chrMargin+8),n=h.config.annotTracksHeight,"overlay"!==h.config.annotationsLayout&&(n*=2),c.selectAll("text.chrLabel").attr("transform","rotate(-90)"+l).selectAll("tspan").attr("x",function(a,c){f=h.config.chrMargin*d;g=-(f+chrMargin2)+3+n;return g/=b.x}).attr("y",k))};
Ideogram.prototype.rotateBandLabels=function(c,d,a){var b,f,e,h,g=this;h=c.selectAll(".bandLabel");b=this.config.chrMargin*d;e=c.attr("data-orientation");"undefined"==typeof a?(a={x:1,y:1},f=""):f="scale("+a.x+","+a.y+")";1==d&&"perspective"in this.config&&"comparative"==this.config.perspective?h.attr("transform",function(a){var c;c=8-b-26;a=g.round(2+a.px.start+a.px.width/2);return"rotate(-90)translate("+c+","+a+")"}).selectAll("text").attr("text-anchor","end"):"vertical"==e?h.attr("transform",function(a){var c;
c=8-b;a=g.round(2+a.px.start+a.px.width/2);return"rotate(-90)translate("+c+","+a+")"}).selectAll("text").attr("transform",f):(h.attr("transform",function(c){return"translate("+g.round(-8*a.x+c.px.start+c.px.width/2)+","+(b-10)+")"}).selectAll("text").attr("transform",f),c.selectAll(".bandLabelStalk line").attr("transform",f))};Ideogram.prototype.round=function(c){return Math.round(100*c)/100};
Ideogram.prototype.drawChromosome=function(c,d){var a,b,f,e,h,g,k,m;k=this;g=k.bump;h="telocentric"!=c.centromerePosition?g:Math.round(g/4)+3;a=d3.select("svg").append("g").attr("id",c.id).attr("class","chromosome");b=k.config.chrWidth;var l=k.config.chrMargin*d;a.selectAll("path").data(c.bands).enter().append("path").attr("id",function(a){a=a.name.replace(".","-");return c.id+"-"+a}).attr("class",function(a){var b="band "+a.stain;"acen"==a.stain&&(b+=" "+a.name[0]+"-cen");return b}).attr("d",function(a,
f){var e=k.round(a.px.width),d=k.round(a.px.start),n,m,p;p=0;"acen"==a.stain?(k.adjustedBump?(p=.35,e=.2,d-=.1,"q"===a.name[0]&&(d+=1.2)):e-=g/2,n=l+p,m=b/2-2*p,p=b-2*p,"p"==a.name[0]?a="M "+d+" "+n+" l "+e+" 0 q "+g+" "+m+" 0 "+p+" l -"+e+" 0 z":(k.adjustedBump&&(e+=.2),a="M "+(d+e+g/2)+" "+n+" l -"+e+" 0 q -"+(g+.5)+" "+m+" 0 "+p+" l "+e+" 0 z")):(0==f&&(d+=h-g/2,!0===k.config.multiorganism&&(d+=h)),k.adjustedBump&&"q"===a.name[0]&&(d+=1.8),f==c.bands.length-1&&(d-=h-g/2),a="M "+d+" "+l+" l "+e+
" 0 l 0 "+b+" l -"+e+" 0 z");return a});"telocentric"!=c.centromerePosition?a.append("path").attr("class","p-ter chromosomeBorder "+c.bands[0].stain).attr("d","M "+(h-g/2+.1)+" "+l+" q -"+h+" "+b/2+" 0 "+b):(a.append("path").attr("class","p-ter chromosomeBorder "+c.bands[0].stain).attr("d","M "+(h-3)+" "+l+" l -"+(h-2)+" 0 l 0 "+b+" l "+(h-2)+" 0 z"),a.insert("path",":first-child").attr("class","acen").attr("d","M "+(h-3)+" "+(l+.1*b)+" l "+(h+g/2+1)+" 0 l 0 "+.8*b+" l -"+(h+g/2+1)+" 0 z"));m=k.adjustedBump?
1.8:0;f=c.pcenIndex;var n=c.bands[f];e=c.bands[f+1];0<f?(f=n.px.start,e=e.px.stop+m):(f=2,e=document.querySelectorAll("#"+c.id+" .band")[0].getBBox().x);m=e+(c.width-e+1.3*m)-g/2-.5;a.append("line").attr("class","cb-p-arm-top chromosomeBorder").attr("x1",g/2).attr("y1",l).attr("x2",f).attr("y2",l);a.append("line").attr("class","cb-p-arm-bottom chromosomeBorder").attr("x1",g/2).attr("y1",b+l).attr("x2",f).attr("y2",b+l);a.append("line").attr("class","cb-q-arm-top chromosomeBorder").attr("x1",e).attr("y1",
l).attr("x2",m).attr("y2",l);a.append("line").attr("class","cb-q-arm-bottom chromosomeBorder").attr("x1",e).attr("y1",b+l).attr("x2",m).attr("y2",b+l);a.append("path").attr("class","q-ter chromosomeBorder "+c.bands[c.bands.length-1].stain).attr("d","M "+m+" "+l+" q "+g+" "+b/2+" 0 "+b)};
Ideogram.prototype.initTransformChromosome=function(c,d){if("vertical"==this.config.orientation){var a,b;b=this.config.chrWidth;a=this.config.chrMargin*d;this.config.showBandLabels||(d+=2);a+=(b-4)*(d-1);c.attr("data-orientation","vertical").attr("transform","rotate(90, "+(a-30)+", "+a+")");this.rotateBandLabels(c,d)}else c.attr("data-orientation","horizontal")};
Ideogram.prototype.rotateAndToggleDisplay=function(c){var d,a,b,f,e,h,g,k,m=this;d=d3.select("#"+c);a=m.chromosomes[m.config.taxid][c.split("-")[0].split("chr")[1]].chrIndex;otherChrs=d3.selectAll("g.chromosome").filter(function(a,b){return this.id!==c});g=m.config.orientation;k=d.attr("data-orientation");b=this.config.chrMargin*a;f=this.config.chrWidth;e=d3.select("#ideogram")[0][0].getBoundingClientRect();h=e.height;e=e.width;"vertical"==g?(chrLength=d[0][0].getBoundingClientRect().height,e=e/chrLength*
.97,h=1.5,scale="scale("+e+", "+h+")",inverseScaleX=2/e,inverseScaleY=1,this.config.showBandLabels||(a+=2),f=b+(f-4)*(a-1)-30,verticalTransform="rotate(90, "+f+", "+(f+30)+")",b=-1*(b-this.config.annotTracksHeight)*h,this.config.showBandLabels&&(b+=25),horizontalTransform="rotate(0)translate(20, "+b+")"+scale):(chrLength=d[0][0].getBoundingClientRect().width,e=h/chrLength*.97,scale="scale("+e+", 1.5)",inverseScaleX=2/e,inverseScaleY=1,h=20,this.config.showBandLabels||(a+=2,h=15),f=b+(f-h)*(a-2),b=
f+5,this.config.showBandLabels||(f+=h,b+=h),verticalTransform="rotate(90, "+f+", "+b+")"+scale,horizontalTransform="");inverseScale="scale("+inverseScaleX+","+inverseScaleY+")";"vertical"!=k?("horizontal"==g&&otherChrs.style("display","none"),d.selectAll(".annot>path").attr("transform","vertical"==g?"":inverseScale),d.attr("data-orientation","vertical").transition().attr("transform",verticalTransform).each("end",function(){scale="vertical"==g?"":{x:inverseScaleY,y:inverseScaleX};m.rotateBandLabels(d,
a,scale);m.rotateChromosomeLabels(d,a,"horizontal",scale);"vertical"==g&&otherChrs.style("display","")})):(d.attr("data-orientation",""),"vertical"==g&&otherChrs.style("display","none"),d.selectAll(".annot>path").transition().attr("transform","vertical"==g?inverseScale:""),d.transition().attr("transform",horizontalTransform).each("end",function(){inverseScale="horizontal"==g?"vertical"==k?{x:1,y:1}:"":{x:inverseScaleX,y:inverseScaleY};m.rotateBandLabels(d,a,inverseScale);m.rotateChromosomeLabels(d,
a,"",inverseScale);"horizontal"==g&&otherChrs.style("display","")}))};Ideogram.prototype.convertBpToPx=function(c,d){var a,b;for(a=0;a<c.bands.length;a++)if(b=c.bands[a],d>=b.bp.start&&d<=b.bp.stop)return a=(b.iscn.stop-b.iscn.start)/(b.bp.stop-b.bp.start),a=b.iscn.start+(d-b.bp.start)*a,b=30+b.px.start+b.px.width*(a-b.iscn.start)/(b.iscn.stop-b.iscn.start);throw Error("Base pair out of range.  bp: "+d+"; length of chr"+c.name+": "+b.bp.stop);};
Ideogram.prototype.convertPxToBp=function(c,d){var a,b;for(a=0;a<c.bands.length;a++)if(b=c.bands[a],d>=b.px.start&&d<=b.px.stop)return pxToIscnScale=(b.iscn.stop-b.iscn.start)/(b.px.stop-b.px.start),a=b.iscn.start+(d-b.px.start)*pxToIscnScale,bp=b.bp.start+(b.bp.stop-b.bp.start)*(a-b.iscn.start)/(b.iscn.stop-b.iscn.start),Math.round(bp);throw Error("Pixel out of range.  px: "+bp+"; length of chr"+c.name+": "+b.px.stop);};
Ideogram.prototype.drawSynteny=function(c){var d=(new Date).getTime(),a,b,f,e,h,g,k,m,l;h=d3.select("svg").append("g").attr("class","synteny");for(g=0;g<c.length;g++)regions=c[g],a=regions.r1,b=regions.r2,k="#CFC","color"in regions&&(k=regions.color),m=1,"opacity"in regions&&(m=regions.opacity),a.startPx=this.convertBpToPx(a.chr,a.start),a.stopPx=this.convertBpToPx(a.chr,a.stop),b.startPx=this.convertBpToPx(b.chr,b.start),b.stopPx=this.convertBpToPx(b.chr,b.stop),f=document.querySelectorAll("#"+a.chr.id+
" path")[0].getBBox(),e=document.querySelectorAll("#"+b.chr.id+" path")[0].getBBox(),f=f.y-30,e=e.y-29,l=a.chr.id+"_"+a.start+"_"+a.stop+"___"+b.chr.id+"_"+b.start+"_"+b.stop,syntenicRegion=h.append("g").attr("class","syntenicRegion").attr("id",l).on("click",function(){var a=this,b=d3.selectAll(".syntenicRegion").filter(function(b,c){return this!==a});b.classed("hidden",!b.classed("hidden"))}).on("mouseover",function(){var a=this;d3.selectAll(".syntenicRegion").filter(function(b,c){return this!==
a}).classed("ghost",!0)}).on("mouseout",function(){d3.selectAll(".syntenicRegion").classed("ghost",!1)}),syntenicRegion.append("polygon").attr("points",f+", "+a.startPx+" "+f+", "+a.stopPx+" "+e+", "+b.stopPx+" "+e+", "+b.startPx).attr("style","fill: "+k+"; fill-opacity: "+m),syntenicRegion.append("line").attr("class","syntenyBorder").attr("x1",f).attr("x2",e).attr("y1",a.startPx).attr("y2",b.startPx),syntenicRegion.append("line").attr("class","syntenyBorder").attr("x1",f).attr("x2",e).attr("y1",
a.stopPx).attr("y2",b.stopPx);c=(new Date).getTime();this.debug&&console.log("Time in drawSyntenicRegions: "+(c-d)+" ms")};
Ideogram.prototype.processAnnotData=function(c){var d,a,b,f,e,h,g,k;f=[];for(d=0;d<c.length;d++)for(annotsByChr=c[d],f.push({chr:annotsByChr.chr,annots:[]}),a=0;a<annotsByChr.annots.length;a++)e=annotsByChr.chr,ra=annotsByChr.annots[a],b=ra[1],h=ra[2]+b,g=this.chromosomes["9606"][e],e=this.convertBpToPx(g,b),g=this.convertBpToPx(g,h),e=Math.round((e+g)/2)-28,k="#F00",this.config.annotationTracks?(g=ra[3],k=this.config.annotationTracks[g].color):g=0,b={id:ra[0],chrIndex:d,start:b,stop:h,px:e,color:k,
trackIndex:g},f[d].annots.push(b);return f};
Ideogram.prototype.getHistogramBars=function(c){var d=(new Date).getTime(),a,b,f,e,h,g,k,m,l;k=[];b=this.config.barWidth;e=this.chromosomes[this.config.taxid];for(f in e){chrModel=e[f];chrIndex=chrModel.chrIndex;lastBand=chrModel.bands[chrModel.bands.length-1];a=lastBand.px.stop;numBins=Math.round(a/b);g={chr:f,annots:[]};for(a=0;a<numBins;a++)h=a*b-this.bump,bp=this.convertPxToBp(chrModel,h+this.bump),g.annots.push({bp:bp,px:h,count:0,chrIndex:chrIndex,color:"#F00"});k.push(g)}for(f in c)for(g=c[f].annots,
chrName=c[f].chr,chrModel=e[chrName],chrIndex=chrModel.chrIndex,barAnnots=k[chrIndex-1].annots,a=0;a<g.length;a++)for(h=g[a],h=h.px,b=0;b<barAnnots.length-1;b++)if(m=barAnnots[b].px,l=barAnnots[b+1].px,h>m&&h<l){k[chrIndex-1].annots[b].count+=1;break}for(a=f=0;a<k.length;a++)for(c=k[a].annots,b=0;b<c.length;b++)barCount=c[b].count,barCount>f&&(f=barCount);for(a=0;a<k.length;a++)for(c=k[a].annots,b=0;b<c.length;b++)barCount=c[b].count,height=barCount/f*this.config.chrMargin,k[a].annots[b].height=height;
c=(new Date).getTime();this.debug&&console.log("Time spent in getHistogramBars: "+(c-d)+" ms");return k};
Ideogram.prototype.drawAnnots=function(c){var d,a,b,f,e,h,g,k,m,l=this;d=this.config.chrMargin;a=this.config.chrWidth;b="tracks";this.config.annotationsLayout&&(b=this.config.annotationsLayout);"histogram"===b&&(c=l.getHistogramBars(c));f=this.config.annotationHeight;e="l -"+f+" "+2*f+" l "+2*f+" 0 z";c=d3.selectAll(".chromosome").data(c).selectAll("path.annot").data(function(a){return a.annots}).enter();"tracks"===b?c.append("g").attr("id",function(a,b){return a.id}).attr("class","annot").attr("transform",
function(b){return"translate("+b.px+","+((b.chrIndex+1)*d+a+b.trackIndex*f*2)+")"}).append("path").attr("d","m0,0"+e).attr("fill",function(a){return a.color}):"overlay"===b?c.append("polygon").attr("id",function(a,b){return a.id}).attr("class","annot").attr("points",function(b){h=b.px-.5;g=b.px+.5;k=(b.chrIndex+1)*d+a;m=(b.chrIndex+1)*d;return h+","+k+" "+g+","+k+" "+g+","+m+" "+h+","+m}).attr("fill",function(a){return a.color}):"histogram"===b&&c.append("polygon").attr("class","annot").attr("points",
function(b){h=b.px+l.bump;g=b.px+l.config.barWidth+l.bump;k=b.chrIndex*d+a;m=b.chrIndex*d+a+b.height;b=l.chromosomesArray[b.chrIndex-1].width;g>b&&(g=b);return h+","+k+" "+g+","+k+" "+g+","+m+" "+h+","+m}).attr("fill",function(a){return a.color});if(l.onDrawAnnotsCallback)l.onDrawAnnotsCallback()};
Ideogram.prototype.putChromosomesInRows=function(){var c=this.config.rows,d,a,b,f,e,h;d=Math.floor(this.config.chromosomes[this.config.taxid].length/c);f=0;"g"!==d3.select("svg > *")[0][0].tagName&&(f=2);for(var g=1;g<c;g++)a=d*g+1+f,b=a+d,range="nth-child(n+"+a+"):nth-child(-n+"+b+")",e=this.config.chrHeight+20,a=a+1-f,b=this.config.chrWidth,h=this.config.chrMargin*a,this.config.showBandLabels||(a+=2),this.config.showChromosomeLabels&&(e+=12),rowWidth=h+(b-4)*a+8,d3.selectAll("#ideogram .chromosome:"+
range).attr("transform",function(a,b){return d3.select(this).attr("transform")+("translate("+e+", "+rowWidth+")")})};Ideogram.prototype.onBrushMove=function(){call(this.onBrushMoveCallback)};
Ideogram.prototype.createBrush=function(c,d){var a=this,b=a.config.chrWidth+6.5,f=a.chromosomesArray[0],e=f.bands[f.bands.length-1].bp.stop,h,g;g=[0];h=[0];for(var k,m=0;m<f.bands.length;m++)k=f.bands[m],g.push(k.bp.stop),h.push(k.px.stop);f=d3.scale.linear().domain(g).range(h);g=d3.select(".band")[0][0].getBBox().y-3.25;"undefined"===typeof c&&(c=Math.floor(e/10));"undefined"===typeof right&&(d=Math.ceil(2*c));e=c;h=d;a.selectedRegion={from:c,to:d,extent:d-c};a.brush=d3.svg.brush().x(f).extent([e,
h]).on("brush",function(){var b=a.brush.extent(),c=Math.floor(b[0]),b=Math.ceil(b[1]);a.selectedRegion={from:c,to:b,extent:b-c};if(a.onBrushMove)a.onBrushMoveCallback()});d3.select("#ideogram").append("g").attr("class","brush").attr("transform","translate(0, "+g+")").call(a.brush).selectAll("rect").attr("height",b)};Ideogram.prototype.onLoad=function(){call(this.onLoadCallback)};Ideogram.prototype.onDrawAnnots=function(){call(this.onDrawAnnotsCallback)};
Ideogram.prototype.getBandColorGradients=function(){var c,d,a="";c=[["gneg","#FFF","#FFF","#DDD"],["gpos25","#C8C8C8","#DDD","#BBB"],["gpos33","#BBB","#BBB","#AAA"],["gpos50","#999","#AAA","#888"],["gpos66","#888","#888","#666"],["gpos75","#777","#777","#444"],["gpos100","#444","#666","#000"],["acen","#FEE","#FEE","#FDD"]];for(var b=0;b<c.length;b++)d=c[b][0],color1=c[b][1],color2=c[b][2],color3=c[b][3],a+='<linearGradient id="'+d+'" x1="0%" y1="0%" x2="0%" y2="100%">',a="gneg"==d?a+('<stop offset="70%" stop-color="'+
color2+'" /><stop offset="95%" stop-color="'+color3+'" /><stop offset="100%" stop-color="'+color1+'" />'):a+('<stop offset="5%" stop-color="'+color1+'" /><stop offset="15%" stop-color="'+color2+'" /><stop offset="60%" stop-color="'+color3+'" />'),a+="</linearGradient>";a="<defs>"+(a+'<pattern id="stalk" width="2" height="1" patternUnits="userSpaceOnUse" patternTransform="rotate(30 0 0)"><rect x="0" y="0" width="10" height="2" fill="#CCE" /> <line x1="0" y1="0" x2="0" y2="100%" style="stroke:#88B; stroke-width:0.7;" /></pattern><pattern id="gvar" width="2" height="1" patternUnits="userSpaceOnUse" patternTransform="rotate(-30 0 0)"><rect x="0" y="0" width="10" height="2" fill="#DDF" /> <line x1="0" y1="0" x2="0" y2="100%" style="stroke:#99C; stroke-width:0.7;" /></pattern>')+
"</defs>";css='<style>.gneg {fill: url("#gneg")} .gpos25 {fill: url("#gpos25")} .gpos33 {fill: url("#gpos33")} .gpos50 {fill: url("#gpos50")} .gpos66 {fill: url("#gpos66")} .gpos75 {fill: url("#gpos75")} .gpos100 {fill: url("#gpos100")} .acen {fill: url("#acen")} .stalk {fill: url("#stalk")} .gvar {fill: url("#gvar")} </style>';return a=css+a};
Ideogram.prototype.init=function(){function c(){var b,c,d,g,k,l=e.config.taxids;m=[];var r=(new Date).getTime();for(d=0;d<l.length;d++)for(a=l[d],k=e.bandData[a],f=e.config.chromosomes[a],g=0;g<f.length;g++)b=f[g],c=e.getBands(k,b,a),m.push(c),b=c[c.length-1].iscn.stop,c=c[c.length-1].bp.stop,b>e.maxLength.iscn&&(e.maxLength.iscn=b),c>e.maxLength.bp&&(e.maxLength.bp=c);d=(new Date).getTime();this.debug&&console.log("Time in getBands: "+(d-r)+" ms");k=0;r=(new Date).getTime();for(d=0;d<l.length;d++){a=
l[d];f=e.config.chromosomes[a];e.chromosomes[a]={};for(g=0;g<f.length;g++)c=m[k],k+=1,b=f[g],c=e.getChromosomeModel(c,b,a,k),e.chromosomes[a][b]=c,e.chromosomesArray.push(c),e.drawChromosome(c,k);!0===e.config.showBandLabels&&e.drawBandLabels(e.chromosomes)}for(d=k=0;d<l.length;d++)for(a=l[d],f=e.config.chromosomes[a],g=0;g<f.length;g++)k+=1,b=f[g],chrModel=e.chromosomes[a][b],chr=d3.select("#chr"+b+"-"+a),e.initTransformChromosome(chr,k);if(e.config.annotationsPath){var p=function(){"undefined"!==
typeof timeout&&window.clearTimeout(timeout);e.annots=e.processAnnotData(e.rawAnnots);e.drawAnnots(e.annots)};e.rawAnnots?p():function t(){timeout=setTimeout(function(){e.rawAnnots?p():t()},50)}()}if(!0===e.config.showBandLabels&&(d=e.bandsToShow.join(","),l=(new Date).getTime(),d3.selectAll(".bandLabel, .bandLabelStalk").style("display","none"),d3.selectAll(d).style("display",""),d=(new Date).getTime(),this.debug&&console.log("Time in showing bands: "+(d-l)+" ms"),"vertical"===e.config.orientation))for(l=
0;l<e.chromosomesArray.length;l++)e.rotateChromosomeLabels(d3.select("#"+e.chromosomesArray[l].id),l);!0===e.config.showChromosomeLabels&&e.drawChromosomeLabels(e.chromosomes);1<e.config.rows&&e.putChromosomesInRows();!0===e.config.brush&&e.createBrush();l=(new Date).getTime();this.debug&&console.log("Time in drawChromosome: "+(l-r)+" ms");l=(new Date).getTime();this.debug&&console.log("Time constructing ideogram: "+(l-h)+" ms");if(e.onLoadCallback)e.onLoadCallback()}var d=!0===this.config.multiorganism,
a,b,f,e=this,h=(new Date).getTime();if(0==d)"undefined"==typeof this.config.taxid&&(e.config.taxid="9606"),a=this.config.taxid,b=[a],this.config.taxids=b,f=this.config.chromosomes.slice(),e.config.chromosomes={},e.config.chromosomes[a]=f;else for(e.coordinateSystem="bp",b=this.config.taxids,d=0;d<b.length;d++)a=b[d];e.config.annotationsPath&&d3.json(e.config.annotationsPath,function(a){e.rawAnnots=a.annots});d="";e.config.showChromosomeLabels&&(d="horizontal"==e.config.orientation?d+"labeledLeft ":
d+"labeled ");this.config.annotationsLayout&&"overlay"===this.config.annotationsLayout&&(d+="faint");var g;"vertical"===e.config.orientation?(g=e.config.chrHeight+30,1<e.config.rows&&(g=e.config.rows*(g-30))):g=e.config.chrMargin*f.length+30;var k=e.getBandColorGradients();d3.select(this.config.container).append("svg").attr("id","ideogram").attr("class",d).attr("width","97%").attr("height",g).html(k);var m=[],l=0;g=this.config.resolution;for(d=0;d<b.length;d++)a=b[d],bandDataFileNames={9606:"ideogram_9606_GCF_000001305.14_"+
g+"_V1",10090:"ideogram_10090_GCF_000000055.19_NA_V2"},"undefined"===typeof chrBands?d3.xhr("data/bands/ncbi/"+bandDataFileNames[a]).on("beforesend",function(b){b.taxid=a}).get(function(a,d){e.bandData[d.taxid]=d.response;l+=1;l==b.length&&c()}):(e.bandData["9606"]=chrBands,c())};
//# sourceMappingURL=ideogram.js.map
